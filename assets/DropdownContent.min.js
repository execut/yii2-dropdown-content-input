$.widget("execut.dropdownContent",{inputEl:null,items:null,containerEl:null,scrolledContainer:null,options:{itemSelector:".item",ignoredElementsSelector:"",isDisable:true,isFocus:true,isAllowFocus:true,isScroll:true,isFixed:false,isExpand:false},_create:function(){var a=this;a._initElements();a._initEvents();a._initValue();a._checkDisable();a._initItems();if(a.containerEl.hasClass("expanded")||a.isExpanded()||a.isFixed()){a.openContainer(true);if(a.options.isScroll){window.scroll(a.inputEl.offset().top,0)}}else{a.closeContainer();a._trigger("close")}a.initClearButtons();a._recalculateFixed()},_jsPaneApi:null,_initJsPane:function(){var b=this;if(!b._jsPaneApi){var a=b.containerEl.css("max-height").match(/\d+/);if(a&&Number(a[0])<=b.containerEl.outerHeight()){b._jsPaneApi=b.scrolledContainer.jScrollPane({horizontal:false,mouseWheelSpeed:15}).data("jsp")}else{b._jsPaneApi=false}}},_recalculateFixed:function(){var a=this,b=a.element;if(a.isFixed()){a.openContainer();b.addClass("fixed-content")}else{if(b.hasClass("fixed-content")){a.closeContainer();b.removeClass("fixed-content")}}},_initElements:function(){var a=this,b=a.element;a.wrapperEl=b.find(".dropdown-wrapper");a.hiddenInput=a.wrapperEl.find("input[type=hidden]");a.inputEl=a.wrapperEl.find("input[type=text]");if(!a.options.isAllowFocus){a.inputEl.focus(function(){a.inputEl.blur()})}a.containerEl=b.find(".dropdown-content-container");if(a.containerEl.find(".scrollable-content").length){a.scrolledContainer=a.containerEl.find(".scrollable-content")}else{a.scrolledContainer=a.containerEl}a.caretEl=[];if(a.wrapperEl.find(".controll-wrapper").length){a.caretEl[a.caretEl.length]=a.wrapperEl.find(".controll-wrapper")[0]}if(a.containerEl.find(".caret").length){a.caretEl[a.caretEl.length]=a.containerEl.find(".caret")[0]}a.caretEl=$(a.caretEl);a.formEl=a.inputEl.parents("form");a.formEls=a.formEl.find(":input:not(.tree-input):not(.kv-search-input):not(:button)");a.clearEl=a.element.find(".clear");a.wrapperEl.css("z-index",0);$('label[for="'+a.hiddenInput.attr("id")+'"]').attr("for",a.inputEl.attr("id"))},_initValue:function(){var a=this,b=a.hiddenInput.val();if(b){a.inputEl.val(a.getItems().filter('[val="'+b+'"]').attr("text"))}},getItems:function(){var a=this;return a.containerEl.find(a.options.itemSelector)},_initEvents:function(){var b=this;if(b.caretEl.length){b.caretEl.click(function(){b.toggleContainer()})}b.inputEl.click(function(){if(b.isSkipFocus){b.isSkipFocus=false}else{if(b.options.isAllowFocus){b.openContainer()}else{b.toggleContainer()}}});b.inputEl.keyup(function(c){if(c.keyCode==13){b.getItems().filter(".selected").click()}else{b.openContainer();b.getItems().removeClass("selected");b.getItems().each(function(h,e){var d=$(e),g=d.text().toLowerCase(),f=b.inputEl.val().toLowerCase();if(f.length==0){return false}if(g.match(new RegExp("^"+b._escapeRegExp(f)))){d.addClass("selected");return false}})}});$(document.body).click(function(d){var c=$(d.target).is(b.caretEl)||$(d.target).is(b.caretEl.children().first());if(!$(d.target).is(b.inputEl)&&!$(d.target).is(b.containerEl)&&(b.containerEl.has($(d.target)).length)==0&&!c){b.closeContainer()}});b.clearEl.click(function(){b.clear()});b.hiddenInput.change(function(){b.initClearButtons()});b._initItemsEvents();for(var a=0;a<b.options.depends.length;a++){(function(){var d=b.options.depends[a],c=$("#"+d);c.change(function(){if(c.val()===""){b.clear();b.disable()}else{b.reload(b._replaceElementName(c.attr("name")))}})})()}$(window).scroll(function(){b._recalcContainerPosition()});$(window).resize(function(){b._recalculateFixed();b.reinitializeScroll()})},_recalcContainerPosition:function(){var i=this;if(!i.element.hasClass("active")){return}i.containerEl.css("top","");var j=i.containerEl.outerHeight(true),c=i.containerEl.offset().top,a=i.inputEl.outerHeight(true),h=i.inputEl.offset().top,d=-a,f=i.containerEl;while(f.length&&f.parent().css("position")!=="relative"){d=f.height();f=f.parent()}if(!f.length){d=0}if(d>a){d=d-i.element.outerHeight(true)}else{d=0}var g=h>=j,b=($(window.top).height()-h+$(window).scrollTop()-a)>j,e=(h-$(window).scrollTop())>(a+82);if(((h-$(window).scrollTop()>$(window).scrollTop()+$(window.top).height()-h+a)||((h-$(window).scrollTop())>j&&i.element.hasClass("topped")))&&g){i.containerEl.css("top",(-j+d)+"px");i.element.addClass("topped")}else{i.containerEl.css("top","");i.element.removeClass("topped")}},initClearButtons:function(){var a=this;if(a.hiddenInput.val()===""){a.clearEl.hide()}else{a.clearEl.show()}},clear:function(){var a=this;if(a.hiddenInput.val()!==""){a._trigger("clear");a._setSelectedItemValues($());a.hiddenInput.change();a.closeContainer()}},_initItems:function(){var a=this;if(a.hiddenInput.val()&&a.hiddenInput.val().length){var b=a.getItems().filter('*[val="'+a.hiddenInput.val()+'"]').addClass("selected");if(!b.length){a.hiddenInput.val("");a.inputEl.val("")}}},_checkDisable:function(){var a=this;if(!a.getItems().length){a.disable()}else{a.enable()}},reload:function(c){var a=this,b=a.serializeForm();b["Filter[changedAttribute]"]=c;a.disable();$.get(a.options.ajaxUrl,b,function(d){a.containerEl.children().remove();a.containerEl.html(d);a._initItemsEvents();a._checkDisable();a.inputEl.val("").trigger("change").change();a.hiddenInput.val("").trigger("change").change();if(d!==""){a.enable();a.openContainer()}})},serializeForm:function(){var b=this,c={},d=b.formEls;d.filter(function(){var e=jQuery(this),f=e.attr("name");f=b._replaceElementName(f);c[f]=e.val()});for(var a in c){if(c[a]==""||c[a]===null){delete c[a]}}return c},_replaceElementName:function(b){var a=this;b=b.replace(a.options.formName,"Filter",b);return b},disable:function(){var a=this;if(a.options.isDisable){a.inputEl.val("");a.hiddenInput.val("").change();a.getItems().removeClass("selected");a.inputEl.attr("disabled","disabled");a.element.attr("disabled","disabled")}},enable:function(){var a=this;a.inputEl.attr("disabled",false);a.element.attr("disabled",false)},_initItemsEvents:function(){var a=this;a.containerEl.on("click",a.options.itemSelector,function(f){var c=$(this),b=$(f.target),d=a.hiddenInput.val();if(!c.is(a.options.itemSelector)){return false}if(a.options.ignoredElementsSelector.length&&(b.is(a.options.ignoredElementsSelector)||c.is(a.options.ignoredElementsSelector))){return false}a._setSelectedItemValues(c);a.closeContainer();if(d!==a.hiddenInput.val()){a.hiddenInput.change()}return false})},_setSelectedItemValues:function(b){var d=this,e=b.attr("val"),c=b.attr("text");d.getItems().removeClass("selected");b.addClass("selected");d.inputEl.val(c);var a=d.hiddenInput.val();if(a!==e){d.hiddenInput.val(e)}},toggleContainer:function(){var a=this;if(a.containerEl.is(":visible")){a.closeContainer()}else{a.openContainer()}},isSkipFocus:false,openContainer:function(b){var a=this;a._trigger("open",null,{isFromCreate:b});a.containerEl.show();if(!a.isFixed()){a.element.addClass("active")}if(!a.inputEl.is(":focus")){if(a.options.isAllowFocus){a.isSkipFocus=true}if(a.options.isFocus){a.inputEl.focus()}}if(a.element.css("position")==="fixed"){$(document.body).css("overflow","hidden")}a._recalcContainerPosition();a._initJsPane();a.reinitializeScroll()},reinitializeScroll:function(){var a=this;if(a._jsPaneApi){a._jsPaneApi.reinitialise()}},isExpanded:function(){var a=this;if(a.options.isExpand.length!==false){if(a.options.isExpand.method==="width"){if(a.options.isExpand.width<=$(window).width()){return true}else{return false}}}return a.options.isExpand},isFixed:function(){var a=this;if(a.options.isFixed.length!==false){if(a.options.isFixed.method==="width"){if(a.options.isFixed.width<=$(window).width()){return true}else{return false}}}return a.options.isFixed},_escapeRegExp:function(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},closeContainer:function(){var b=this,c=b.getItems().filter(".selected");if(b.isFixed()){return}b.element.removeClass("topped");if(b.element.css("position")==="fixed"){$(document.body).css("overflow","scroll")}b.wrapperEl.css("z-index",0);if(b.containerEl.is(":visible")){b.element.removeClass("active");if(c.length){b._setSelectedItemValues(c)}else{var a=b.inputEl.val()!=="";b.inputEl.val("");b.hiddenInput.val("");if(a){b.hiddenInput.change()}}b.containerEl.hide();b._trigger("close")}b._recalcContainerPosition()}});